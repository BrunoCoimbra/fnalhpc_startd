#!/bin/bash

# Launch a full stack CMS glidein on a set of THETA nodes

if [ "$2" = "" ] ; then
    echo "Usage: $0 <THETA user> <node cnt> [<THETA base directory>]" 1>&2
    exit 1
fi

THETA_USER="$1"
NODE_CNT="$2"
THETA_BASE_DIR="$3"

SLOT_PREFIX="cobalt_${RANDOM}"
GLIDEIN_NAME="$SLOT_PREFIX@theta.alcf.anl.gov"

if [ "$THETA_BASE_DIR" = "" ] ; then
 THETA_BASE_DIR="/home/macosta/job_area/${SLOT_PREFIX}"
fi

SOURCE="$(dirname "${PWD}")"
FNAL_BASE_DIR=`pwd`

echo Using directory $THETA_BASE_DIR at THETA

# Set up local Condor installation
echo Writing local files 
cp -dR ${SOURCE}/skeleton/* .
chmod 400 pool_password
echo LOCAL_DIR=${FNAL_BASE_DIR} >>condor_config
cat >config.d/97-personal2.conf <<EOF
# Run-time settings for this personal condor setup
#new startd name
NUM_SLOTS_TYPE_1 = $NODE_CNT
MASTER_NAME = $GLIDEIN_NAME
STARTD_NAME = $GLIDEIN_NAME
EOF


# create sshfs connection
echo Creating sshfs connection
ssh ${THETA_USER}@theta.alcf.anl.gov mkdir ${THETA_BASE_DIR}
sshfs -o allow_other -o nonempty ${THETA_USER}@theta.alcf.anl.gov:${THETA_BASE_DIR} ./theta_gpfs


# write theta files
echo Writing THETA files
mkdir theta_gpfs/rendezvous theta_gpfs/log theta_gpfs/execute
cp -a ${SOURCE}/theta_files/* theta_gpfs/
cat >theta_gpfs/job.cobalt <<EOF
#!/bin/bash

# number of nodes
#COBALT -n 1
# wall time request, this is 30min
#COBALT -t 1:00:00
# one of the two debug queues, only difference is KNL cache settings
#COBALT -q debug-cache-quad
# project, this should work for the ALCC allocation
#COBALT -A HighLumin

# MPI launcher, 1 node, 1 MPI rank per node
# basically starts mycommand on both nodes in the batch job
aprun -n 1 -N 1 --cc none ./cms_init_start.sh

EOF

chmod a+rx theta_gpfs/job.cobalt

echo Files written, blahp job already at login node ready to be submitted 

# Submit cobalt job
ssh ${THETA_USER}@theta.alcf.anl.gov /bin/bash -l -c "'cd ${THETA_BASE_DIR}; qsub -A HighLumin -q debug-cache-quad -t 60 -n 1 job.cobalt'"
echo ssh return $? \n

# launch master
echo Starting local condor
export CONDOR_CONFIG=${FNAL_BASE_DIR}/condor_config
/usr/sbin/condor_master
