#!/bin/bash

# Launch a glidein on a set of THETA nodes

if [ "$2" = "" ] ; then
    echo "Usage: $0 <THETA user> <node cnt> [<THETA base directory>]" 1>&2
    exit 1
fi

THETA_USER="$1"
NODE_CNT="$2"
THETA_BASE_DIR="$3"
if [ "$THETA_BASE_DIR" = "" ] ; then
THETA_BASE_DIR="$3"/glidein_`whoami`_$$
fi
GLIDEIN_NAME=`whoami`
SOURCE=/cloud/login/macosta/fnalhpc_startd
FNAL_BASE_DIR=`pwd`

echo Using directory $THETA_BASE_DIR at THETA \n

# Set up the local Condor installation
echo Writing local files 
cp -dR ${SOURCE}/skeleton/* .
chmod 400 pool_password
echo LOCAL_DIR=${FNAL_BASE_DIR} >>condor_config
cat >config.d/97-personal2.conf <<EOF
# Run-time settings for this personal condor setup
#new startd name
NUM_SLOTS_TYPE_1 = $NODE_CNT
MASTER_NAME = $GLIDEIN_NAME
STARTD_NAME = $GLIDEIN_NAME
EOF


# create sshfs connection
echo Creating sshfs connection
ssh ${THETA_USER}@theta.alcf.anl.gov mkdir ${THETA_BASE_DIR}

read -n 1 -s -r -p "Check if -> ${THETA_BASE_DIR} was created"

sshfs -o allow_other ${THETA_USER}@theta.alcf.anl.gov:${THETA_BASE_DIR} ./theta_gpfs


# write theta files
echo Writing THETA files \n
mkdir theta_gpfs/rendezvous theta_gpfs/log theta_gpfs/execute
cp -a ${SOURCE}/theta_files/* theta_gpfs/
cat >theta_gpfs/job.cobalt <<EOF
#!/bin/bash

# number of nodes
#COBALT -n 2
# wall time request, this is 30min
#COBALT -t 0:30:00
# one of the two debug queues, only difference is KNL cache settings
#COBALT -q debug-cache-quad
# project, this should work for the ALCC allocation
#COBALT -A HighLumin

# MPI launcher, 2 nodes, 1 MPI rank per node
# basically starts mycommand on both nodes in the batch job
aprun -n 2 -N 1 --cc none ./node.sh

EOF

chmod a+rx theta_gpfs/job.cobalt

echo Files written, blahp job already at login node ready to be submitted 

# submit slurm job
ssh ${THETA_USER}@theta.alcf.anl.gov /bin/bash -l -c "'cd ${THETA_BASE_DIR}; qsub -A HighLumin -q debug-cache-quad -t 30 -n 2 job.cobalt'"
echo ssh return $? \n

read -n 1 -s -r -p "Done, now staring condor here -> ${HOSTNAME} .. continue? "

# launch master
echo Starting condor \n
export CONDOR_CONFIG=${FNAL_BASE_DIR}/condor_config
/usr/sbin/condor_master
